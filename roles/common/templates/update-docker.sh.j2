#!/bin/bash
#
# Update Docker Containers Script
# Generated by Ansible - DO NOT EDIT MANUALLY
# Machine: {{ hostname }}
# Domain: {{ domain }}
#

set -e

echo "=================================="
echo "Docker Container Update - {{ hostname }}"
echo "=================================="
echo ""

HOMELAB_DIR="{{ homelab_dir }}"

# Function to update a service
update_service() {
    local service_dir="$1"
    local service_name=$(basename "$service_dir")
    
    if [ ! -f "$service_dir/docker-compose.yml" ]; then
        echo "‚ö†Ô∏è  Skipping $service_name (no docker-compose.yml found)"
        return
    fi
    
    echo "üì¶ Updating $service_name..."
    cd "$service_dir"
    
    # Pull latest images
    if docker compose pull; then
        echo "   ‚úÖ Images pulled"
    else
        echo "   ‚ùå Failed to pull images"
        return 1
    fi
    
    # Recreate containers with new images
    if docker compose up -d --force-recreate; then
        echo "   ‚úÖ Containers updated"
    else
        echo "   ‚ùå Failed to update containers"
        return 1
    fi
    
    # Clean up old images
    echo "   üßπ Cleaning up old images..."
    docker image prune -f > /dev/null 2>&1
    
    echo ""
}

# Change to homelab directory
if [ ! -d "$HOMELAB_DIR" ]; then
    echo "‚ùå Homelab directory not found: $HOMELAB_DIR"
    exit 1
fi

cd "$HOMELAB_DIR"

# If specific service provided as argument, update only that
if [ -n "$1" ]; then
    SERVICE_DIR="$HOMELAB_DIR/$1"
    if [ -d "$SERVICE_DIR" ]; then
        update_service "$SERVICE_DIR"
    else
        echo "‚ùå Service directory not found: $1"
        exit 1
    fi
else
    # Update all services
    echo "üîÑ Updating all services..."
    echo ""
    
    for service_dir in "$HOMELAB_DIR"/*/; do
        # Skip if not a directory or doesn't have docker-compose.yml
        if [ -d "$service_dir" ] && [ -f "$service_dir/docker-compose.yml" ]; then
            update_service "$service_dir"
        fi
    done
fi

echo "=================================="
echo "‚úÖ Update Complete!"
echo "=================================="
