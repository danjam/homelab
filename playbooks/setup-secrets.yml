---
# Setup Secrets Playbook
# =======================
# Run this ONCE before deploying to generate keys and set up vault
# This is STEP 1 of the deployment workflow
#
# Usage: ansible-playbook playbooks/setup-secrets.yml

- name: Generate Required Keys and Setup Vault
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    beszel_key_path: "{{ playbook_dir }}/../.secrets/beszel_hub_key"
    secrets_dir: "{{ playbook_dir }}/../.secrets"
    vault_file: "{{ playbook_dir }}/../inventory/group_vars/all/vault.yml"
  
  tasks:
    - name: Create secrets directory
      file:
        path: "{{ secrets_dir }}"
        state: directory
        mode: '0700'
    
    - name: Check if Beszel keypair exists
      stat:
        path: "{{ beszel_key_path }}"
      register: beszel_key_stat
    
    - name: Generate Beszel Hub ED25519 keypair
      command: >
        ssh-keygen -t ed25519 
        -f {{ beszel_key_path }}
        -N "" 
        -C "beszel-hub"
      when: not beszel_key_stat.stat.exists
    
    - name: Read Beszel private key
      slurp:
        src: "{{ beszel_key_path }}"
      register: beszel_private_key
    
    - name: Read Beszel public key
      slurp:
        src: "{{ beszel_key_path }}.pub"
      register: beszel_public_key
    
    - name: Display Beszel keys
      debug:
        msg:
          - "============================================"
          - "Beszel Hub Keys Generated!"
          - "============================================"
          - ""
          - "PRIVATE KEY:"
          - "{{ beszel_private_key.content | b64decode }}"
          - ""
          - "PUBLIC KEY:"
          - "{{ beszel_public_key.content | b64decode | trim }}"
          - ""
          - "============================================"
          - "Keys stored in: {{ secrets_dir }}"
          - "DO NOT commit .secrets/ directory to git!"
          - "============================================"
    
    - name: Ensure .secrets is in .gitignore
      lineinfile:
        path: "{{ playbook_dir }}/../.gitignore"
        line: ".secrets/"
        create: yes
    
    - name: Display next steps
      debug:
        msg:
          - ""
          - "╔════════════════════════════════════════════════════════════╗"
          - "║  SETUP COMPLETE - Next Steps                               ║"
          - "╚════════════════════════════════════════════════════════════╝"
          - ""
          - "STEP 2: Fill in secrets in the vault file"
          - "  Edit: {{ vault_file }}"
          - "  "
          - "  Replace these placeholders with your real values:"
          - "    - vault_beszel_hub_private_key (use key shown above)"
          - "    - vault_beszel_hub_public_key (use key shown above)"
          - "    - vault_cloudflare_email"
          - "    - vault_cloudflare_dns_token"
          - "    - vault_default_password"
          - "    - vault_telegram_bot_token"
          - "    - vault_telegram_chat_id"
          - "    - vault_lastfm_apikey (orac only)"
          - "    - vault_lastfm_secret (orac only)"
          - "    - vault_spotify_id (orac only)"
          - "    - vault_spotify_secret (orac only)"
          - "    - vault_nas_username (orac only)"
          - "    - vault_nas_password (orac only)"
          - ""
          - "STEP 3: Encrypt the vault file"
          - "  ansible-vault encrypt {{ vault_file }}"
          - ""
          - "STEP 4: Deploy the homelab"
          - "  ansible-playbook playbooks/site.yml"
          - ""
          - "═══════════════════════════════════════════════════════════"
