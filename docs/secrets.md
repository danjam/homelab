# Secret Management Guide

## Overview

This homelab uses `ansible-vault` to encrypt sensitive data. All secrets are stored in `vault.yml` files which are encrypted before being committed to git.

## Vault Files

- `inventory/group_vars/all/vault.yml` - Global secrets (Cloudflare, Telegram, Beszel keys)
- `host_vars/orac/vault.yml` - orac-specific secrets (Last.fm, Spotify, NAS)
- `host_vars/jarvis/vault.yml` - jarvis-specific secrets (currently none)
- `host_vars/seraph/vault.yml` - seraph-specific secrets (currently none)

## Setup

### First Time

```bash
# Run setup playbook to generate Beszel keys
ansible-playbook playbooks/setup-secrets.yml

# Edit vaults and fill in your secrets
ansible-vault edit inventory/group_vars/all/vault.yml
ansible-vault edit host_vars/orac/vault.yml

# Encrypt vaults
ansible-vault encrypt inventory/group_vars/all/vault.yml
ansible-vault encrypt host_vars/orac/vault.yml
```

## Required Secrets

### Global (`inventory/group_vars/all/vault.yml`)

**You must provide:**
- `vault_cloudflare_email` - Your Cloudflare account email
- `vault_cloudflare_dns_token` - Cloudflare DNS API token
- `vault_default_password` - Default password for services
- `vault_telegram_bot_token` - Telegram bot token (shared by jarvis/seraph)
- `vault_telegram_chat_id` - Telegram chat ID (shared by jarvis/seraph)

**Auto-generated by playbook:**
- `vault_beszel_hub_private_key` - Beszel hub private key (ED25519)
- `vault_beszel_hub_public_key` - Beszel hub public key (all agents use this)

### orac (`host_vars/orac/vault.yml`)

**You must provide:**
- `vault_lastfm_apikey` - Last.fm API key (for Navidrome)
- `vault_lastfm_secret` - Last.fm API secret
- `vault_spotify_id` - Spotify client ID (for Navidrome)
- `vault_spotify_secret` - Spotify client secret
- `vault_nas_username` - NAS username
- `vault_nas_password` - NAS password

## Working with Vault Files

### Edit Encrypted Files

```bash
ansible-vault edit inventory/group_vars/all/vault.yml
ansible-vault edit host_vars/orac/vault.yml
```

### View Without Editing

```bash
ansible-vault view inventory/group_vars/all/vault.yml
```

### Change Vault Password

```bash
ansible-vault rekey inventory/group_vars/all/vault.yml host_vars/*/vault.yml
```

## Getting API Credentials

### Cloudflare DNS Token
1. Log in to Cloudflare dashboard
2. Go to Profile → API Tokens
3. Create Token → Edit zone DNS template
4. Select your domain
5. Copy the token

### Last.fm API
1. Go to https://www.last.fm/api/account/create
2. Create an API account
3. Copy API key and shared secret

### Spotify API
1. Go to https://developer.spotify.com/dashboard
2. Create an app
3. Copy Client ID and Client Secret

### Telegram Bot
1. Message @BotFather on Telegram
2. Create a new bot
3. Copy the bot token
4. Get chat ID by messaging your bot and checking updates

## Vault Password

The vault password is stored in `.ansible-vault-pass` (not in repo).

```bash
# Create password file
openssl rand -base64 32 > .ansible-vault-pass
chmod 600 .ansible-vault-pass
```

**Important:** Backup this password securely!

## Best Practices

1. Never commit unencrypted vault files
2. Verify encryption before committing: `head -1 */vault.yml` should show `$ANSIBLE_VAULT;1.1;AES256`
3. Use `ansible-vault edit` to modify secrets, never decrypt manually
4. Rotate external API tokens periodically
