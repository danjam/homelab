# Adding New Services Guide

## Overview

This guide shows how to add new services to your homelab using the existing Ansible structure. We'll use adding a service as an example.

## Step 1: Create a New Role

Create the role directory structure:

```bash
mkdir -p roles/myservice/{tasks,templates,handlers}
```

## Step 2: Create Role Tasks

Create `roles/myservice/tasks/main.yml`:

```yaml
---
# MyService role - Deploy my service

- name: Create service directory
  ansible.builtin.file:
    path: "{{ homelab_dir }}/myservice"
    state: directory
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"
    mode: '0755'

- name: Deploy docker-compose
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ homelab_dir }}/myservice/docker-compose.yml"
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"
    mode: '0644'
  notify: restart myservice

- name: Deploy .env file
  ansible.builtin.template:
    src: .env.j2
    dest: "{{ homelab_dir }}/myservice/.env"
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"
    mode: '0600'
  notify: restart myservice

- name: Start service
  community.docker.docker_compose_v2:
    project_src: "{{ homelab_dir }}/myservice"
    state: present
    pull: "{{ auto_pull_images | default(true) }}"
    recreate: "{{ recreate_containers | default('auto') }}"
```

## Step 3: Create Docker Compose Template

Create `roles/myservice/templates/docker-compose.yml.j2`:

```yaml
---
services:
  myservice:
    image: myservice/myservice:latest
    container_name: myservice
    restart: {{ container_restart_policy }}
    networks:
      - web
    environment:
      - PUID={{ puid }}
      - PGID={{ pgid }}
      - TZ={{ timezone }}
    volumes:
      - {{ myservice_config_path }}:/config
      - {{ myservice_data_path }}:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.myservice.rule=Host(`{{ myservice_subdomain }}.{{ domain }}`)"
      - "traefik.http.routers.myservice.entrypoints=websecure"
      - "traefik.http.routers.myservice.tls.certresolver=cloudflare"
      - "traefik.http.services.myservice.loadbalancer.server.port=8080"

networks:
  web:
    name: web
    external: true
```

## Step 4: Create Environment Template

Create `roles/myservice/templates/.env.j2`:

```yaml
# MyService environment variables
# Generated by Ansible - do not edit manually

PUID={{ puid }}
PGID={{ pgid }}
TZ={{ timezone }}

# Service-specific variables
CONFIG_PATH={{ myservice_config_path }}
DATA_PATH={{ myservice_data_path }}
DOMAIN={{ domain }}
```

## Step 5: Create Handlers

Create `roles/myservice/handlers/main.yml`:

```yaml
---
# MyService handlers

- name: restart myservice
  community.docker.docker_compose_v2:
    project_src: "{{ homelab_dir }}/myservice"
    state: restarted
```

## Step 6: Add Variables

Add to machine's `host_vars/machineX/vars.yml`:

```yaml
# Add to services list
services:
  - traefik
  - beszel
  - myservice  # Add your service

# Service-specific configuration
myservice_enabled: true
myservice_config_path: "{{ homelab_dir }}/myservice/config"
myservice_data_path: /mnt/data/myservice
myservice_subdomain: myservice
```

## Step 7: Add Secrets (if needed)

If your service needs secrets, add to `host_vars/machineX/vault.yml`:

```yaml
vault_myservice_api_key: "your-secret-key"
vault_myservice_password: "your-password"
```

Then encrypt:
```bash
ansible-vault encrypt host_vars/machine1/vault.yml
```

## Step 8: Update Playbook

Add to `playbooks/site.yml`:

```yaml
    - role: myservice
      when: "'myservice' in services"
      tags: ['myservice']
```

## Step 9: Deploy

```bash
# Dry run first
ansible-playbook playbooks/site.yml --tags myservice --check --diff

# Deploy
ansible-playbook playbooks/site.yml --tags myservice

# Or deploy to specific machine
ansible-playbook playbooks/site.yml --tags myservice --limit machine1
```

## Common Service Patterns

### Service with Multiple Containers

```yaml
services:
  app:
    # Main app config
  
  database:
    image: postgres:15
    # Database config
```

### Service with External Networks

```yaml
networks:
  web:
    name: web
    external: true
  internal:
    name: myservice_internal
    driver: bridge
```

### Service with Volumes

```yaml
volumes:
  - {{ myservice_config }}:/config
  - {{ myservice_data }}:/data:rw
  - /path/to/shared:/shared:ro  # Read-only
```

## Tips

1. **Start with existing roles** - Copy and modify Traefik or Beszel as templates
2. **Test on one machine first** - Use `--limit jarvis` (simplest setup)
3. **Use check mode** - Test before deploying with `--check --diff`
4. **Keep roles simple** - One service per role
5. **Document variables** - Add comments in vars.yml
6. **Use handlers** - For service restarts
7. **Tag appropriately** - Makes selective deployment easier

## Example: Adding Sonarr

See the full example in the repository for adding Sonarr as a media management service.
